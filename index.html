<!DOCTYPE html>
<html lang='ja'>
  <head>
    <meta charset="utf-8">
    <base target="_top">
    <!--<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/black-tie/jquery-ui.css">-->
  </head>
  <!--<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>-->
  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <?!= getContent("datetimepicker_css.html")?>
    <?!= getContent("datetimepicker_javascript.html")?>
  <body>
<p>gmail送信予約入力画面</p>
<script>
  // 画面初期表示
  $(function() {
    $('#btn_reserve').click(function(e) { 
     var mailNumber = document.getElementById("text_answer").value;
     var arrayDate = [];
     for(var i = 0; i < mailNumber; i++){
       //console.log(document.getElementById("new").children[i].children[1].value);
       arrayDate.push(document.getElementById("new").children[i].children[1].value);
     }
     google.script.run.withSuccessHandler(onAddSuccess).Reserve(document.getElementById("url").value, arrayDate);
     //google.script.run.withSuccessHandler(onAddSuccess).test(this.parentNode, arrayDate);
    }); 
    function onAddSuccess(res) {
      $('#btn_answer').text('予約完了');
    }
    $('#datetimepicker').datetimepicker();
  });
  
  $(function() {
    $('#mailLoadButton').click(function(e) { 
      <?
      var draft = GmailApp.getDraftMessages();
      
      if (draft.length > 0) {
        var rows = [];
        var count = 0;
        for (var i = draft.length - 1, j = 2; i >= 0; i--, j++) { //下書きを古いものから順に読み込む バックアップから日時を取得
          if (draft[i].getTo() !== "") {
            rows.push([draft[i].getId(), draft[i].getTo(), draft[i].getSubject()]);?>
             var div_element = document.createElement("div");
             div_element.innerHTML = '<p>メールID：<?=draft[i].getId()?>, To：<?=draft[i].getTo()?>, Sub：<?=draft[i].getSubject()?></p>日付：<input type="text" name="date<?=String(count)?>" id="datetimepicker<?=String(count)?>">';
             var parent_object = document.getElementById("new");
             parent_object.appendChild(div_element);
             <?count++;?>
             document.getElementById("text_answer").value = <?=count?>;
          <?}
        }
      }
      ?>
      for (var i=0; i < <?=count?>; i++){
      $('#datetimepicker'+String(i)).datetimepicker();
    }
    })
  });
</script>
<div>
</div>
<form style="margin: 20px 20px;">
  <p>スプレッドシートのURL：<input type="text" id="url" style="width:60%;"></p>
  <input type="button" id="mailLoadButton" value="メール読み込み" onclick="disabled = true;">
  <div id="new"></div>
  <input type="button" id="btn_reserve" value="送信予約">
  <div id="btn_answer"></div>
  <input hidden type="text" id="text_answer">
</form>
  </body>
</html>